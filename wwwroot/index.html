<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Anonymous Live Chat</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    #messageInput { width: 80%; }
  </style>
</head>
<body>
  <h1>Anonymous Live Chat</h1>
  <div id="chat"></div>
  <input type="text" id="messageInput" placeholder="Type a message..." />
  <button id="sendButton">Send</button>

  <!-- Reference the SignalR client library from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js" crossorigin="anonymous"></script>
  <script>
    // Generate a random username for anonymity.
    const user = 'User-' + Math.floor(Math.random() * 100000);
    const chatDiv = document.getElementById("chat");

    // Build the SignalR connection.
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("/chat")
      .build();

    // When a new message is received, append it to the chat window.
    connection.on("ReceiveMessage", function (chatMessage) {
      const time = new Date(chatMessage.timestamp).toLocaleTimeString();
      const messageElem = document.createElement("div");
      messageElem.textContent = `[${time}] ${chatMessage.displayName}: ${chatMessage.message}`;
      chatDiv.appendChild(messageElem);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    });

    // Start the connection.
    connection.start().then(function () {
      console.log("Connected as " + user);
      // Load previous messages (only those within the last 24 hours).
      fetch('/messages')
        .then(response => response.json())
        .then(data => {
          data.forEach(chatMessage => {
            const time = new Date(chatMessage.timestamp).toLocaleTimeString();
            const messageElem = document.createElement("div");
            messageElem.textContent = `[${time}] ${chatMessage.displayName}: ${chatMessage.message}`;
            chatDiv.appendChild(messageElem);
          });
          chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    }).catch(function (err) {
      console.error(err.toString());
    });

    // Send a message when the send button is clicked.
    document.getElementById("sendButton").addEventListener("click", function () {
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value.trim();
      if (message) {
        connection.invoke("SendMessage", user, user, message)
          .catch(function (err) {
            console.error(err.toString());
          });
        messageInput.value = "";
      }
    });

    // Allow sending the message with the Enter key.
    document.getElementById("messageInput").addEventListener("keyup", function (event) {
      if (event.key === "Enter") {
        document.getElementById("sendButton").click();
      }
    });
  </script>
</body>
</html>
